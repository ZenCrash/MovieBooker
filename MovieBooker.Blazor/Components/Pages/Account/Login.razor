@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Mvc
@using Microsoft.AspNetCore.Mvc.RazorPages
@using Microsoft.AspNetCore.Mvc.Rendering
@using System.Linq
@using System.Text.RegularExpressions;
@using MovieBooker.DataAccess.Model;

@inject NavigationManager NavigationManager
@inject SignInManager<User> SignInManager

@page "/login"

<h3>Login</h3>

<div>
    <div class="col-3">
        <EditForm Model="@_inputModel" OnValidSubmit="OnLogin" OnInvalidSubmit="InvalidLogin" FormName="Login">
            <DataAnnotationsValidator />
            @*Email*@
            <div class="form-group" style="margin:10px">
                <label class="form-label" for="@_inputModel.Username">Email, Username: *</label>
                <InputText class="form-control" id="@_inputModel.Username" @bind-Value="_inputModel.Username" type="email" />
                <ValidationMessage For="@(() => _inputModel.Username)" class="text-danger" />
            </div>
            @*Password*@
            <div class="form-group" style="margin:10px">
                <label class="form-label" for="@_inputModel.Password">Password: *</label>
                <InputText class="form-control" id="@_inputModel.Password" @bind-Value="@_inputModel.Password" type="password" />
                <ValidationMessage For="@(() => _inputModel.Password)" class="text-danger" />
            </div>
            <button type="submit" class="btn btn-primary" style="margin-top: 10px;">Login</button>
        </EditForm>
        <ul class="text-danger">
            @foreach (var item in errorMessages)
            {
                <li>
                    <p>@item</p>
                </li>
            }
        </ul>
    </div>
</div>

@code {

    protected override void OnInitialized()
    {

    }

    [SupplyParameterFromForm]
    private InputModel _inputModel { get; set; } = new();
    private List<string> errorMessages { get; set; } = new();

    private async Task OnLogin()
    {
        errorMessages.Clear();

        var result = await SignInManager.PasswordSignInAsync(
            _inputModel.Username,
            _inputModel.Password,
            isPersistent: false, //Remember Me
            lockoutOnFailure: false);

        if (result.Succeeded)
        {
            NavigationManager.NavigateTo("/");
        }
        else if (result.IsLockedOut)
        {
            errorMessages.Add("User account locked out.");
        }
        else if (result.IsNotAllowed)
        {
            //todo impliment
            errorMessages.Add("Error login failed, User not allowed to sign in");
        }
        else if (result.RequiresTwoFactor)
        {
            //todo impliment
            //Navigation.NavigateTo("/two-factor-authentication");
        }
        else
        {
            errorMessages.Add("Error login failed");
        }
    }

    private async Task InvalidLogin()
    {

    }

    //Input Model Code
    private class InputModel
    {
        [Required(ErrorMessage = "Username is required.")]
        public string Username { get; set; }

        [Required(ErrorMessage = "Password is required.")]
        public string Password { get; set; }
    }
}

